<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thinkgem.jeesite.modules.letsapi.dao.MallOrderDao">
    
    
    <sql id="orderList">
		a.id AS "id",
		a.ORDER_NO AS "orderNo",
		a.ORDER_STATUS AS "orderStatus",
		a.ORDER_AMOUNT_TOTAL AS "orderAmountTotal",
		A.PRODUCT_AMOUNT_TOTAL AS "productAmountTotal",
		b.SHOP_USER_NAME AS "shopUserName",
		b.PHONE AS "phone",
		b.AREAR AS "arear",
		b.ADDRESS_DETAIL AS "addressDetail"
	</sql>
    <!-- 新增订单 mall_rder -->
	<insert id="insertOrder">
		INSERT INTO MALL_ORDER
       (ID,
        ORDER_NO,
        USER_ID,
        ORDER_STATUS,
        PRODUCT_AMOUNT_TOTAL,
        ORDER_AMOUNT_TOTAL,
        LOGISTICS_FEE,
        ADDRESS_ID,
        LOGISTICS_COMPANY_NAME,
        ORDERLOGISTICS_ID,
        PAY_CHANNEL,
        PAY_TIME,
        ESCROW_TRADE_NO,
        CREATE_DATE,
        REMARKS,
        CONSIGN,
        COLUMNS1,
        COLUMNS2,
        UPDATE_DATE,
        DEL_FLAG)
     VALUES
       (#{id},
        #{orderNo},
        #{userId},
        #{orderStatus},
        #{productAmountTotal},
        #{orderAmountTotal},
        '',
        #{addressId},
        '',
        '',
        #{payChannel},
        '',
        '',
        sysdate,
        #{remarks},
        '',
        '',
        '',
        sysdate,
        '0')
	</insert>
	
	
	<insert id="insertOrderInfo" parameterType="java.util.List" useGeneratedKeys="false">
	 	insert into MALL_ORDER_INFO(id,order_id,product_id,product_count,del_flag,product_spec_id) 
	  	<foreach collection="list" item="item" index="index" separator="union all">
	   <!-- (#{item.id,jdbcType=VARCHAR},#{item.orderId,jdbcType=VARCHAR},#{item.productId,jdbcType=VARCHAR},
	   #{item.productCount,jdbcType=VARCHAR},'0',#{item.productSpecId,jdbcType=VARCHAR}) -->
	   
	   select #{item.id} id,
	   #{item.orderId} order_id,
	   #{item.productId} product_id,
	   #{item.productCount} product_count,
	   '0',
	   #{item.productSpecId} product_spec_id 
                from dual
 		 </foreach>
	</insert>
	<!-- 查询订单信息 -->
	<select id="getOrderList" resultType="MallOrderInfo">
		SELECT C.PRODUCT_COUNT,
               D.PRODUCT_NAME,
               D.PRODUCT_ICO1,
               E.SPEC_NAME,
               E.SPEC_PRICE    
          FROM MALL_ORDER_INFO        C,
               MALL_PRODUCT_INFO      D,
               PRODUCT_SPECIFICATIONS E
         WHERE C.PRODUCT_ID = D.ID
           AND D.ID = E.PRODUCT_ID
           AND D.DEL_FLAG = '0'
           AND D.STAUTS = '0'
           AND C.ORDER_ID = #{ID}
	</select>
	
	<!-- 一对多查询关联  -->
     <resultMap type="MallOrder" id="slist" >
         <!-- 实体类属性对应数据库的主键字段，不然主键会查不到 -->
         <id property="id" column="id"/>
         <!-- 用collection标签 ,也是实体类属性要对应数据库字段-->
         <collection property="mallOrderInfo" column="id" select="getOrderList" >
         </collection>    
     </resultMap>
     
     <!-- 全表查询 -->
     <select id="selectOrder" resultMap="slist">
    		 select 
	     <include refid = "orderList" />
	         from MALL_ORDER a,SHIPPING_ADDRESS b WHERE a.USER_ID = #{userId}  
	  </select>

</mapper>